# プロダクト要求仕様書: DataHub - Connect AI OEM リファレンス実装

**バージョン**: 1.1
**最終更新**: 2026-02-23

---

## 1. プロダクトビジョンと目的

### ビジョン
CData Connect AI OEMを組み込んだSaaS製品の理想的な統合パターンを示すリファレンスアプリケーション。パートナー企業が自社製品にデータ統合機能を簡単に組み込めることを実証する。

### 目的
1. **技術実証**: Connect AI OEM の HTTP API を活用したマルチデータソース統合の実装方法を示す
2. **商談支援**: パートナー企業へのデモンストレーションで具体的な統合イメージを提供
3. **開発ガイド**: パートナー企業のエンジニアが参考にできる実装パターンとベストプラクティスの提供
4. **差別化要因の提示**: 低コストで多様なデータソースに対応できるOEMソリューションの価値を明示

## 2. ターゲットユーザーと課題・ニーズ

### プライマリターゲット: SaaS/BIツールベンダーの意思決定者
- **役職**: CTO、プロダクトマネージャー、エンジニアリングリーダー
- **企業規模**: スタートアップ〜中堅企業
- **現在提供している製品**: 分析ツール、ダッシュボード、レポーティングツール、データマネジメントツール

### 解決すべき課題
1. **開発コスト**: 各データソースのAPI個別実装に膨大な工数がかかる
2. **保守負担**: API変更への追従、複数SDKのメンテナンスが困難
3. **市場投入速度**: 新しいデータソース対応に時間がかかり、競合に遅れる
4. **技術的負債**: 各データソースごとに異なるインターフェースで複雑性が増大
5. **人材確保**: 多様なAPI知識を持つエンジニアの採用が困難

### ニーズ
- 統一されたインターフェース（SQL）で多様なデータソースにアクセスしたい
- メタデータAPIで動的にUIを生成し、開発工数を削減したい
- エンドユーザー（自社顧客）に自社ブランドでデータ統合機能を提供したい
- セキュアなマルチテナント構成を実装したい
- 迅速にPoCやMVPを構築して市場フィードバックを得たい

## 3. 主要な機能一覧

### Phase 1: 基本機能（MVP）✅ 実装済み
1. マルチテナント認証・アカウント管理
2. データソースコネクション管理UI
3. メタデータエクスプローラー（カタログ/スキーマ/テーブル/カラム）

### Phase 2: クエリ・データ操作 ✅ 実装済み
4. クエリビルダー（SQL入力・実行・結果表示）
5. データCRUD操作（レコード一覧、作成、編集、削除）

### Phase 3: API ログ機能 ✅ 実装済み
6. Connect AI API 呼び出しログの記録・閲覧・削除

## 4. 成功の定義

### デモ時の成功指標
- ✅ 5分以内にパートナーが「自社製品への統合イメージ」を理解できる
- ✅ 3つ以上の異なるデータソース（Salesforce, QuickBooks, Azure DevOpsなど）への接続をライブデモできる
- ✅ メタデータ取得からUI自動生成までの流れを実演できる
- ✅ SQLインジェクション対策などのセキュリティ実装を説明できる
- ✅ APIログ機能でConnect AI API呼び出しの透明性を示せる
- ✅ パートナーから「これなら自社でも実装できそう」というフィードバックを得る

### 技術的成功指標
- ✅ 各データソースへの接続・クエリが正常に動作する
- ✅ レスポンスタイム: メタデータ取得 < 3秒、クエリ実行 < 5秒
- ✅ エラーハンドリングが適切に実装されている
- ✅ コードがクリーンで、パートナーエンジニアが読みやすい

## 5. ユーザーストーリー

### ストーリー1: 初回セットアップ
**As a** SaaSプロダクトのエンドユーザー
**I want to** 自分のSalesforceアカウントを接続する
**So that** 自社のCRMデータを分析ツールで活用できる

**受け入れ基準**:
- 新規ユーザー登録ができる
  - メールアドレス、パスワード、名前を入力
  - 登録時に自動的にConnect AI側に子アカウントが作成される（externalIdとしてユーザーIDを使用）
- コネクション作成フォームでデータソース名を選択し、コネクション名を入力できる
- 「作成」ボタンでConnect AI認証画面にリダイレクトされ、認証情報を入力できる
- 接続したコネクションが一覧に表示される

**技術的な流れ**:
1. ユーザーがメール/パスワードで登録
2. アプリケーションがローカルDBにユーザーレコード作成（user_id = 123）
3. アプリケーションがConnect AI Account APIを呼び出し: `POST /poweredby/account/create { "externalId": "123" }`
4. Connect AIが子アカウントを作成し、`accountId`を返却
5. アプリケーションが`accountId`をユーザーレコードに保存
6. 以降のコネクション作成時は、この`accountId`を使用してConnect AI側のテナント分離を実現

### ストーリー2: データ構造の探索
**As a** ビジネスアナリスト
**I want to** 接続したデータソースのテーブル構造を視覚的に確認する
**So that** どのようなデータが利用可能か把握できる

**受け入れ基準**:
- コネクション選択後、カタログ一覧が表示される
- スキーマ → テーブル → カラムとドリルダウンできる
- 各カラムのデータ型、NULL可否などのメタデータが表示される

### ストーリー3: データのクエリ
**As a** データアナリスト
**I want to** SQL を書いてデータをクエリする
**So that** 任意の条件でデータを取得できる

**受け入れ基準**:
- コネクション選択後、SQLエディタでクエリを入力できる
- パラメータ化クエリ（`@param_name` 形式）を使用できる
- 「実行」ボタンでクエリが実行され、結果がテーブル表示される
- Connect AI への API 呼び出しが `api_logs` に記録される

### ストーリー4: データの編集
**As a** データ管理者
**I want to** 既存レコードを編集・削除する
**So that** データの正確性を維持できる

**受け入れ基準**:
- テーブルのレコード一覧をページネーション付きで表示できる
- 新規レコード作成・編集・削除ができる
- カラムメタデータからフォームが自動生成される

### ストーリー5: API ログの確認（Phase 3）
**As a** 開発者
**I want to** Connect AI API への呼び出し履歴を確認する
**So that** デバッグや動作確認を効率的に行える

**受け入れ基準**:
- `/api-log` 画面で最新のAPI呼び出しログを確認できる
- メソッド、エンドポイント、ステータスコード、応答時間が表示される
- リクエスト・レスポンスの詳細を確認できる
- 「ログをクリア」ボタンで全ログを削除できる

## 6. 機能要件

### 6.1 認証・アカウント管理
- **FR-AUTH-001**: メールアドレスとパスワードでユーザー登録できる
  - ローカルデータベースにユーザー情報を保存
  - 登録時にユーザーIDを`externalId`としてConnect AI Account API (`/poweredby/account/create`) を呼び出し
  - 返却された`accountId`をローカルデータベースに保存
- **FR-AUTH-002**: ログイン・ログアウト機能
  - Flask-Login による Cookie ベースのセッション管理
- **FR-AUTH-003**: セッション管理（Flask-Login）
  - Cookie ベースのサーバーサイドセッション
  - 全保護ページで `@login_required` による認証確認
- **FR-AUTH-004**: テナント分離（ユーザーは自分のコネクションのみアクセス可能）
  - Connect AI側の`accountId`（子アカウント）でテナント分離
- **FR-AUTH-005**: Connect AI Account APIとの連携
  - ユーザー登録時: `POST /poweredby/account/create` で子アカウント作成

### 6.2 コネクション管理
- **FR-CONN-001**: 新規コネクション作成フォーム
  - データソース一覧 (`GET /poweredby/sources/list`) からデータソースを選択
  - Connection Name の入力
  - Connect AI Connection API (`/poweredby/connection/create`) を呼び出し、返却された`redirectURL`にユーザーをリダイレクト
  - ユーザーがCData Connect AIの画面でデータソースの認証情報を入力・完了後、アプリへリダイレクト
- **FR-CONN-002**: コネクション一覧表示（Connect AI から取得）
- **FR-CONN-003**: コネクション削除

### 6.3 メタデータエクスプローラー
- **FR-META-001**: カタログ一覧取得・表示
- **FR-META-002**: スキーマ一覧取得・表示
- **FR-META-003**: テーブル一覧取得・表示
- **FR-META-004**: カラム詳細表示
  - カラム名、データ型、NULL可否など
- **FR-META-005**: ツリービューまたはドリルダウン型ナビゲーション

### 6.4 クエリビルダー
- **FR-QUERY-001**: コネクション選択UI
- **FR-QUERY-002**: SQLエディタ（自由入力）
- **FR-QUERY-003**: パラメータ化クエリのサポート（`@param_name` 形式）
- **FR-QUERY-004**: クエリ実行
- **FR-QUERY-005**: 結果表示（テーブル形式）
- **FR-QUERY-006**: エクスポート機能（CSV）

### 6.5 データCRUD操作
- **FR-CRUD-001**: レコード一覧表示（SELECT）
  - ページネーション対応
- **FR-CRUD-002**: 新規レコード作成
  - カラムメタデータからフォーム自動生成
  - INSERT文実行
- **FR-CRUD-003**: レコード編集
  - 既存データのプリフィル
  - UPDATE文実行
- **FR-CRUD-004**: レコード削除
  - 確認ダイアログ
  - DELETE文実行
- **FR-CRUD-005**: エラーメッセージ表示

### 6.6 API ログ（Phase 3）
- **FR-LOG-001**: Connect AI API 呼び出しの自動記録
  - メソッド、エンドポイント、リクエスト/レスポンスボディ、ステータスコード、応答時間
  - 非同期（バックグラウンドスレッド）で記録
- **FR-LOG-002**: ログ一覧表示（最新 N 件）
- **FR-LOG-003**: ログ全削除

## 7. 非機能要件（デモ用・最小限）

**注**: 本アプリケーションはデモ用途でローカル環境での動作を想定しているため、非機能要件は最小限に絞っています。

### 7.1 セキュリティ（必須）
- **NFR-SEC-001**: すべてのクエリはパラメータ化され、SQLインジェクションを防止する
  - ユーザー入力を直接SQL文に埋め込まない
  - Connect AI API の `parameters` オプションを必ず使用
- **NFR-SEC-002**: パスワードはハッシュ化して保存する
  - bcryptを使用（cost factor: 10以上推奨）
- **NFR-SEC-003**: テナント分離を実装する
  - ユーザーは自分のコネクションのみアクセス可能
  - `connect_ai_account_id` によるConnect AI側のテナント分離

### 7.2 開発環境（推奨）
- **NFR-DEV-001**: 環境変数で設定を管理する（backend/.env）
- **NFR-DEV-002**: READMEに環境構築手順を記載する
- **NFR-DEV-003**: エラー発生時はコンソールにログ出力する

## 8. 受け入れ条件と優先順位

### Phase 1: MVP（実装済み）
**目標**: パートナーに基本的な統合パターンを示せる最小限の機能

| ID | 機能 | 状態 | 受け入れ条件 |
|----|------|------|------------|
| MVP-1 | ユーザー登録・ログイン | ✅ | メール/パスワードでの認証が動作する |
| MVP-2 | コネクション作成 | ✅ | データソースに接続できる |
| MVP-3 | コネクション一覧 | ✅ | 作成したコネクションが一覧表示される |
| MVP-4 | メタデータエクスプローラー | ✅ | カタログ→スキーマ→テーブル→カラムのドリルダウンができる |
| MVP-5 | カラム詳細表示 | ✅ | データ型、NULL可否などが表示される |

### Phase 2: クエリ・CRUD機能（実装済み）
**目標**: データ操作の実用性を示し、メタデータ活用の利点を明確化

| ID | 機能 | 状態 | 受け入れ条件 |
|----|------|------|------------|
| P2-1 | クエリビルダー | ✅ | SQL入力・実行・結果表示ができる |
| P2-2 | パラメータ化クエリ | ✅ | @param 形式のパラメータが使える |
| P2-3 | レコード一覧 | ✅ | ページネーション付きで表示される |
| P2-4 | レコード作成 | ✅ | フォームが自動生成され、INSERTできる |
| P2-5 | レコード編集 | ✅ | 既存データを編集できる |
| P2-6 | レコード削除 | ✅ | 確認後に削除できる |

### Phase 3: API ログ機能（実装済み）
**目標**: Connect AI API の透明性を示し、デバッグを容易にする

| ID | 機能 | 状態 | 受け入れ条件 |
|----|------|------|------------|
| P3-1 | API ログ記録 | ✅ | Connect AI API 呼び出しが自動記録される |
| P3-2 | API ログ閲覧 | ✅ | ログ一覧を画面で確認できる |
| P3-3 | API ログ削除 | ✅ | ログをクリアできる |

## 実装の技術スタック（確定版）

- **Backend**: Python 3.11+, Flask 3.0.0
- **Database**: SQLite（開発）
- **Frontend**: HTML5, Tailwind CSS（CDN）, Alpine.js 3.x（CDN）
- **認証**: Flask-Login 0.6.3（Cookie ベースのセッション管理）
- **ORM**: SQLAlchemy（Flask-SQLAlchemy）
- **Connect AI 連携**: HTTP API クライアント（requests ライブラリ）
- **テスト**: pytest 7.4.3

---

**承認者**: _________________
**承認日**: _________________
