<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>データブラウザ - DataHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/static/js/header.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen" x-data="dataBrowserData()">

  <!-- ヘッダー -->
  <div id="app-header"></div>
  <script>renderAppHeader('data-browser');</script>

  <!-- メインコンテンツ -->
  <main class="max-w-screen-xl mx-auto px-6 py-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">データブラウザ</h2>

    <div class="flex gap-5 items-start">

      <!-- ========== 左カラム: データソース選択 ========== -->
      <div class="w-72 flex-shrink-0">
        <div class="bg-white rounded-xl border border-gray-200 p-5">
          <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">データソース</h3>
          <div class="space-y-2.5">

            <!-- コネクション -->
            <div>
              <label class="block text-xs text-gray-500 mb-1">コネクション</label>
              <div x-show="connections.length === 0 && !error" class="text-xs text-gray-400 py-1">
                <a href="/connections" class="text-blue-600 hover:underline">コネクションを作成</a>してください
              </div>
              <select x-show="connections.length > 0"
                      x-model="selectedConnectionId"
                      @change="onConnectionChange()"
                      class="w-full text-sm border border-gray-300 rounded-lg px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="">選択してください</option>
                <template x-for="conn in connections" :key="conn.id">
                  <option :value="conn.id" x-text="conn.name"></option>
                </template>
              </select>
            </div>

            <!-- カタログ -->
            <div x-show="catalogs.length > 0">
              <label class="block text-xs text-gray-500 mb-1">カタログ</label>
              <select x-model="selectedCatalog" @change="onCatalogChange()"
                      class="w-full text-sm border border-gray-300 rounded-lg px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="">選択してください</option>
                <template x-for="cat in catalogs" :key="cat.TABLE_CATALOG">
                  <option :value="cat.TABLE_CATALOG" x-text="cat.TABLE_CATALOG"></option>
                </template>
              </select>
            </div>

            <!-- スキーマ -->
            <div x-show="schemas.length > 0">
              <label class="block text-xs text-gray-500 mb-1">スキーマ</label>
              <select x-model="selectedSchema" @change="onSchemaChange()"
                      class="w-full text-sm border border-gray-300 rounded-lg px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="">選択してください</option>
                <template x-for="sch in schemas" :key="sch.TABLE_SCHEMA">
                  <option :value="sch.TABLE_SCHEMA" x-text="sch.TABLE_SCHEMA"></option>
                </template>
              </select>
            </div>

            <!-- テーブル -->
            <div x-show="tables.length > 0">
              <label class="block text-xs text-gray-500 mb-1">テーブル</label>
              <select x-model="selectedTable" @change="onTableChange()"
                      class="w-full text-sm border border-gray-300 rounded-lg px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="">選択してください</option>
                <template x-for="tbl in tables" :key="tbl.TABLE_NAME">
                  <option :value="tbl.TABLE_NAME" x-text="tbl.TABLE_NAME"></option>
                </template>
              </select>
            </div>

            <!-- メタデータ ローディング -->
            <div x-show="loadingMeta" class="text-xs text-gray-400">読み込み中...</div>

          </div>

          <!-- キー列選択 -->
          <div x-show="columns.length > 0" class="mt-4 pt-4 border-t border-gray-100">
            <label class="block text-xs text-gray-500 mb-1">キー列（WHERE 条件）</label>
            <select x-model="keyColumn"
                    class="w-full text-sm border border-gray-300 rounded-lg px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
              <template x-for="col in columns" :key="col.COLUMN_NAME">
                <option :value="col.COLUMN_NAME" x-text="col.COLUMN_NAME"></option>
              </template>
            </select>
            <p class="text-xs text-gray-400 mt-1">編集・削除の WHERE 条件に使用するカラム</p>
          </div>
        </div>
      </div>

      <!-- ========== 右カラム: レコード一覧 ========== -->
      <div class="flex-1 min-w-0">

        <!-- ツールバー -->
        <div x-show="selectedTable" class="flex items-center justify-between mb-4">
          <span class="text-sm text-gray-600" x-text="rangeLabel"></span>
          <button @click="openCreateModal()"
                  class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            新規レコード追加
          </button>
        </div>

        <!-- エラー -->
        <div x-show="error" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm mb-4">
          <p x-text="error"></p>
        </div>

        <!-- 成功メッセージ -->
        <div x-show="successMessage" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm mb-4">
          <p x-text="successMessage"></p>
        </div>

        <!-- ローディング -->
        <div x-show="loading" class="bg-white rounded-xl border border-gray-200 p-12 text-center">
          <p class="text-gray-400 text-sm">読み込み中...</p>
        </div>

        <!-- レコード一覧テーブル -->
        <div x-show="!loading && recordColumns.length > 0">
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left px-4 py-3 text-gray-500 font-medium whitespace-nowrap">操作</th>
                    <template x-for="col in recordColumns" :key="col">
                      <th class="text-left px-4 py-3 text-gray-500 font-medium whitespace-nowrap" x-text="col"></th>
                    </template>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  <template x-for="(row, i) in recordRows" :key="i">
                    <tr class="hover:bg-gray-50">
                      <!-- 操作ボタン -->
                      <td class="px-4 py-2.5 whitespace-nowrap">
                        <template x-if="confirmingRowIndex !== i">
                          <div class="flex items-center justify-start gap-2">
                            <button @click="openEditModal(row, i)"
                                    class="text-xs text-blue-600 hover:text-blue-700 font-medium px-2 py-1 rounded border border-blue-200 hover:bg-blue-50 transition-colors">
                              編集
                            </button>
                            <button @click="confirmDelete(i)"
                                    class="text-xs text-red-500 hover:text-red-600 font-medium px-2 py-1 rounded border border-red-200 hover:bg-red-50 transition-colors">
                              削除
                            </button>
                          </div>
                        </template>
                        <!-- 削除確認 -->
                        <template x-if="confirmingRowIndex === i">
                          <div class="flex items-center justify-start gap-2">
                            <span class="text-xs text-red-600">削除しますか？</span>
                            <button @click="cancelDelete()"
                                    class="text-xs text-gray-500 hover:text-gray-700 font-medium px-2 py-1 rounded border border-gray-200 hover:bg-gray-50 transition-colors">
                              キャンセル
                            </button>
                            <button @click="deleteRecord(i)"
                                    class="text-xs text-white font-medium px-2 py-1 rounded bg-red-500 hover:bg-red-600 transition-colors">
                              削除する
                            </button>
                          </div>
                        </template>
                      </td>
                      <!-- データセル -->
                      <template x-for="(cell, j) in row" :key="j">
                        <td class="px-4 py-2.5 text-gray-700 whitespace-nowrap max-w-xs truncate"
                            :title="String(cell ?? '')"
                            x-text="cell ?? ''">
                        </td>
                      </template>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ページネーション -->
          <div class="flex items-center justify-center gap-2 mt-4">
            <button @click="prevPage()" :disabled="offset === 0"
                    class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-40 transition-colors">
              &laquo; 前へ
            </button>
            <button @click="nextPage()" :disabled="!hasNext"
                    class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-40 transition-colors">
              次へ &raquo;
            </button>
          </div>
        </div>

        <!-- データなし -->
        <div x-show="!loading && selectedTable && recordColumns.length === 0 && !error"
             class="bg-white rounded-xl border border-gray-200 border-dashed p-16 text-center">
          <p class="text-gray-300 text-sm">テーブルを選択するとレコードが表示されます</p>
        </div>

      </div>
    </div>
  </main>

  <!-- ========== モーダル: 作成・編集フォーム ========== -->
  <div x-show="showModal" class="fixed inset-0 z-50 flex items-center justify-center">
    <!-- オーバーレイ -->
    <div class="absolute inset-0 bg-black/40" @click="closeModal()"></div>

    <!-- ダイアログ -->
    <div class="relative bg-white rounded-xl shadow-xl w-full max-w-lg max-h-screen overflow-y-auto mx-4">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-base font-semibold text-gray-800"
            x-text="modalMode === 'create' ? '新規レコード追加' : 'レコード編集'"></h3>
        <button @click="closeModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form @submit.prevent="saveRecord()" class="px-6 py-4 space-y-4">
        <!-- エラー（モーダル内） -->
        <div x-show="modalError" class="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-sm">
          <p x-text="modalError"></p>
        </div>

        <!-- 動的フォームフィールド -->
        <template x-for="col in columns" :key="col.COLUMN_NAME">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              <span x-text="col.COLUMN_NAME"></span>
              <span x-show="!col.IS_NULLABLE" class="text-red-500 ml-0.5">*</span>
              <span class="text-xs text-gray-400 font-normal ml-1.5" x-text="col.TYPE_NAME"></span>
            </label>

            <!-- BOOLEAN -->
            <template x-if="inputType(col) === 'checkbox'">
              <select x-model="formData[col.COLUMN_NAME]"
                      class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="">（未設定）</option>
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </template>

            <!-- その他 -->
            <template x-if="inputType(col) !== 'checkbox'">
              <input :type="inputType(col)"
                     :required="!col.IS_NULLABLE"
                     x-model="formData[col.COLUMN_NAME]"
                     class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </template>
          </div>
        </template>

        <div class="flex justify-end gap-3 pt-2 border-t border-gray-100">
          <button type="button" @click="closeModal()"
                  class="text-sm px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
            キャンセル
          </button>
          <button type="submit" :disabled="saving"
                  class="text-sm px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-medium transition-colors">
            <span x-text="saving ? '保存中...' : '保存'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="/static/js/api-client.js"></script>
  <script src="/static/js/auth.js"></script>
  <script>
    function dataBrowserData() {
      return {
        // データソース選択
        connections: [],
        selectedConnectionId: '',
        catalogs: [],
        selectedCatalog: '',
        schemas: [],
        selectedSchema: '',
        tables: [],
        selectedTable: '',
        columns: [],      // getColumns の結果（カラムメタ情報）
        keyColumn: '',    // WHERE に使うカラム名

        // レコード一覧
        recordColumns: [],
        recordRows: [],
        total: -1,
        limit: 20,
        offset: 0,

        // UI 状態
        loading: false,
        loadingMeta: false,
        error: null,
        successMessage: null,

        // 削除確認
        confirmingRowIndex: null,

        // モーダル
        showModal: false,
        modalMode: 'create',   // 'create' | 'edit'
        editingRowIndex: null,
        formData: {},
        saving: false,
        modalError: null,

        // 計算プロパティ
        get hasNext() {
          if (this.total >= 0) return this.offset + this.limit < this.total;
          return this.recordRows.length === this.limit;
        },
        get rangeLabel() {
          if (!this.selectedTable) return '';
          const from = this.offset + 1;
          const to = this.offset + this.recordRows.length;
          if (this.recordRows.length === 0) return 'データがありません';
          if (this.total >= 0) return `${from}〜${to} 件目 / 全 ${this.total} 件`;
          return `${from}〜${to} 件`;
        },

        async init() {
          try {
            const client = new APIClient();
            const data = await client.getConnections();
            this.connections = data.connections;
            if (this.connections.length > 0) {
              this.selectedConnectionId = this.connections[0].id;
              await this.onConnectionChange();
            }
          } catch (e) {
            this.error = e.message;
          }
        },

        async onConnectionChange() {
          this.catalogs = []; this.selectedCatalog = '';
          this.schemas = []; this.selectedSchema = '';
          this.tables = []; this.selectedTable = '';
          this.columns = []; this.keyColumn = '';
          this.recordColumns = []; this.recordRows = []; this.total = -1; this.offset = 0;
          this.error = null;
          if (!this.selectedConnectionId) return;
          this.loadingMeta = true;
          try {
            const client = new APIClient();
            const data = await client.getCatalogs(this.selectedConnectionId);
            this.catalogs = data.catalogs;
            if (this.catalogs.length > 0) {
              this.selectedCatalog = this.catalogs[0].TABLE_CATALOG;
              await this.onCatalogChange();
            }
          } catch (e) {
            this.error = e.message;
          } finally {
            this.loadingMeta = false;
          }
        },

        async onCatalogChange() {
          this.schemas = []; this.selectedSchema = '';
          this.tables = []; this.selectedTable = '';
          this.columns = []; this.keyColumn = '';
          this.recordColumns = []; this.recordRows = []; this.total = -1; this.offset = 0;
          this.error = null;
          if (!this.selectedCatalog) return;
          this.loadingMeta = true;
          try {
            const client = new APIClient();
            const data = await client.getSchemas(this.selectedConnectionId, this.selectedCatalog);
            this.schemas = data.schemas;
            if (this.schemas.length > 0) {
              this.selectedSchema = this.schemas[0].TABLE_SCHEMA;
              await this.onSchemaChange();
            }
          } catch (e) {
            this.error = e.message;
          } finally {
            this.loadingMeta = false;
          }
        },

        async onSchemaChange() {
          this.tables = []; this.selectedTable = '';
          this.columns = []; this.keyColumn = '';
          this.recordColumns = []; this.recordRows = []; this.total = -1; this.offset = 0;
          this.error = null;
          if (!this.selectedSchema) return;
          this.loadingMeta = true;
          try {
            const client = new APIClient();
            const data = await client.getTables(this.selectedConnectionId, this.selectedCatalog, this.selectedSchema);
            this.tables = data.tables;
            if (this.tables.length > 0) {
              this.selectedTable = this.tables[0].TABLE_NAME;
              await this.onTableChange();
            }
          } catch (e) {
            this.error = e.message;
          } finally {
            this.loadingMeta = false;
          }
        },

        async onTableChange() {
          this.columns = []; this.keyColumn = '';
          this.recordColumns = []; this.recordRows = []; this.total = -1; this.offset = 0;
          this.error = null;
          this.confirmingRowIndex = null;
          if (!this.selectedTable) return;
          this.loadingMeta = true;
          try {
            const client = new APIClient();
            const data = await client.getColumns(
              this.selectedConnectionId, this.selectedCatalog, this.selectedSchema, this.selectedTable
            );
            this.columns = data.columns;
            if (this.columns.length > 0) this.keyColumn = this.columns[0].COLUMN_NAME;
          } catch (e) {
            this.error = e.message;
          } finally {
            this.loadingMeta = false;
          }
          await this.loadRecords();
        },

        async loadRecords() {
          if (!this.selectedTable) return;
          this.loading = true;
          this.error = null;
          this.confirmingRowIndex = null;
          try {
            const client = new APIClient();
            const data = await client.getRecords(
              this.selectedConnectionId, this.selectedCatalog, this.selectedSchema,
              this.selectedTable, this.limit, this.offset,
            );
            this.recordColumns = data.columns;
            this.recordRows = data.rows;
            this.total = data.total;
          } catch (e) {
            this.error = e.message;
          } finally {
            this.loading = false;
          }
        },

        nextPage() { this.offset += this.limit; this.loadRecords(); },
        prevPage() { this.offset = Math.max(0, this.offset - this.limit); this.loadRecords(); },

        // ---- フォーム自動生成 ----

        inputType(col) {
          const t = (col.TYPE_NAME || '').toUpperCase();
          if (t === 'BOOLEAN') return 'checkbox';
          if (['INTEGER', 'INT', 'BIGINT', 'SMALLINT', 'TINYINT', 'FLOAT', 'DOUBLE', 'DECIMAL', 'NUMERIC'].includes(t)) return 'number';
          if (t === 'DATE') return 'date';
          if (t === 'TIMESTAMP') return 'datetime-local';
          return 'text';
        },

        // ---- モーダル ----

        openCreateModal() {
          this.modalMode = 'create';
          this.editingRowIndex = null;
          this.formData = {};
          this.modalError = null;
          this.showModal = true;
        },

        openEditModal(row, i) {
          this.modalMode = 'edit';
          this.editingRowIndex = i;
          const obj = {};
          this.recordColumns.forEach((col, j) => { obj[col] = String(row[j] ?? ''); });
          this.formData = obj;
          this.modalError = null;
          this.showModal = true;
        },

        closeModal() {
          this.showModal = false;
          this.modalError = null;
        },

        async saveRecord() {
          this.saving = true;
          this.modalError = null;
          try {
            const client = new APIClient();
            if (this.modalMode === 'create') {
              await client.createRecord(
                this.selectedConnectionId, this.selectedCatalog, this.selectedSchema,
                this.selectedTable, { ...this.formData },
              );
              this.successMessage = 'レコードを追加しました。';
            } else {
              const originalRow = this.recordRows[this.editingRowIndex];
              const keyIdx = this.recordColumns.indexOf(this.keyColumn);
              const where = { [this.keyColumn]: String(originalRow[keyIdx] ?? '') };
              await client.updateRecord(
                this.selectedConnectionId, this.selectedCatalog, this.selectedSchema,
                this.selectedTable, { ...this.formData }, where,
              );
              this.successMessage = 'レコードを更新しました。';
            }
            this.closeModal();
            await this.loadRecords();
          } catch (e) {
            this.modalError = e.message;
          } finally {
            this.saving = false;
          }
          // 成功メッセージを 3 秒後に消す
          setTimeout(() => { this.successMessage = null; }, 3000);
        },

        // ---- 削除 ----

        confirmDelete(i) { this.confirmingRowIndex = i; },
        cancelDelete()   { this.confirmingRowIndex = null; },

        async deleteRecord(i) {
          const row = this.recordRows[i];
          const keyIdx = this.recordColumns.indexOf(this.keyColumn);
          const where = { [this.keyColumn]: String(row[keyIdx] ?? '') };
          this.error = null;
          try {
            const client = new APIClient();
            await client.deleteRecord(
              this.selectedConnectionId, this.selectedCatalog, this.selectedSchema,
              this.selectedTable, where,
            );
            this.successMessage = 'レコードを削除しました。';
            this.confirmingRowIndex = null;
            await this.loadRecords();
          } catch (e) {
            this.error = e.message;
            this.confirmingRowIndex = null;
          }
          setTimeout(() => { this.successMessage = null; }, 3000);
        },
      };
    }
  </script>
</body>
</html>
