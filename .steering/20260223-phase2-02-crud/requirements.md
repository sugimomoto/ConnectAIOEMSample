# 要求定義: Phase 2-02 データ CRUD 操作

**作業ディレクトリ**: `.steering/20260223-phase2-02-crud/`
**作成日**: 2026-02-23
**対応プロダクト要求**: P2-5 / P2-6 / P2-7 / P2-8

---

## 1. 背景・目的

Phase 2-01（クエリビルダー）で SELECT クエリの実行が可能になった。
本フェーズでは Connect AI の SQL API を使い、**レコードの閲覧・作成・編集・削除**（CRUD）機能を実装する。

メタデータ API から取得したカラム情報をもとにフォームを動的生成することで、
「データソースごとのコーディング不要でデータ操作 UI を構築できる」という OEM の強みをデモする。

---

## 2. 対象機能と優先度

| ID   | 機能           | 優先度 | 受け入れ条件 |
|------|--------------|--------|------------|
| P2-5 | レコード一覧   | P0     | ページネーション付きで表示される |
| P2-6 | レコード作成   | P0     | フォームが自動生成され、INSERT できる |
| P2-7 | レコード編集   | P1     | 既存データを編集できる |
| P2-8 | レコード削除   | P1     | 確認後に削除できる |

---

## 3. ユーザーストーリー

### 3.1 レコード一覧（P2-5）

**As a** データ管理者
**I want to** 接続したデータソースのテーブルレコードをブラウザで閲覧したい
**So that** データの内容を確認し、必要に応じて操作できる

**受け入れ基準**:
- コネクション → カタログ → スキーマ → テーブルをセレクトボックスで選択すると、レコード一覧が表示される
- 1 ページあたり 20 件表示し、ページネーション（前へ／次へ）で操作できる
- 合計レコード件数が表示される（例: 「1〜20 件目 / 全 150 件」）
- 各行に「編集」「削除」ボタンが表示される（P2-7 / P2-8 が対象）
- 未認証のまま API にアクセスすると 401 が返る

### 3.2 レコード作成（P2-6）

**As a** データ管理者
**I want to** 新しいレコードをフォームから追加したい
**So that** データソースにデータを INSERT できる

**受け入れ基準**:
- 「新規レコード追加」ボタンを押すと、カラムメタデータから自動生成されたフォームが表示される
- 各入力欄はカラムの型（VARCHAR / INTEGER / BOOLEAN / DATE 等）に応じた適切なウィジェット（input type）になる
- `IS_NULLABLE = false` のカラムは必須入力としてマークされる
- フォームを送信すると INSERT 文が実行され、成功メッセージが表示される
- INSERT 後はレコード一覧に戻り、新規追加されたレコードが確認できる
- Connect AI エラー（型不一致など）は UI 上にエラーメッセージとして表示される
- 未認証のまま API にアクセスすると 401 が返る

### 3.3 レコード編集（P2-7）

**As a** データ管理者
**I want to** 既存のレコードを編集したい
**So that** データを最新の状態に保てる

**受け入れ基準**:
- 一覧の「編集」ボタンを押すと、現在の値がプリフィルされたフォームが表示される
- フォームを送信すると UPDATE 文が実行され、成功メッセージが表示される
- UPDATE の WHERE 条件には主キー情報（後述の技術制約を参照）を使用する
- 成功後はレコード一覧に戻り、変更が反映されていることが確認できる
- Connect AI エラーは UI 上にエラーメッセージとして表示される
- 未認証のまま API にアクセスすると 401 が返る

### 3.4 レコード削除（P2-8）

**As a** データ管理者
**I want to** 不要なレコードを削除したい
**So that** データを整理できる

**受け入れ基準**:
- 一覧の「削除」ボタンを押すと「本当に削除しますか？」確認ダイアログが表示される
- 確認後に DELETE 文が実行される
- 削除成功後はレコード一覧がリフレッシュされ、該当レコードが消えていることを確認できる
- Connect AI エラーは UI 上にエラーメッセージとして表示される
- 未認証のまま API にアクセスすると 401 が返る

---

## 4. 機能要件

### 4.1 API エンドポイント

| メソッド | エンドポイント           | 説明           | 優先度 |
|---------|------------------------|--------------|--------|
| GET     | `/api/v1/data/records` | レコード一覧取得 | P0     |
| POST    | `/api/v1/data/records` | レコード作成   | P0     |
| PUT     | `/api/v1/data/records` | レコード更新   | P1     |
| DELETE  | `/api/v1/data/records` | レコード削除   | P1     |

### 4.2 レコード一覧 GET パラメータ

| パラメータ    | 必須 | 説明 |
|-------------|------|------|
| connection_id | ✓ | Connect AI のコネクション ID |
| catalog      | ✓ | カタログ名 |
| schema       | ✓ | スキーマ名 |
| table        | ✓ | テーブル名 |
| limit        |     | 取得件数（デフォルト 20、最大 100） |
| offset       |     | 取得開始位置（デフォルト 0） |

### 4.3 レコード作成・更新 POST/PUT ボディ

```json
{
  "connection_id": "conn-001",
  "catalog": "Salesforce1",
  "schema": "dbo",
  "table": "Account",
  "data": {
    "Name": "Acme Corp",
    "Industry": "Technology"
  },
  "where": {
    "Id": "001xxxxxxxxxxxxxxx"
  }
}
```

- `data`: INSERT / UPDATE する値（カラム名 → 値）
- `where`: UPDATE / DELETE の条件（カラム名 → 値、クライアントが主キーを渡す）
  - PUT / DELETE のみ必須

### 4.4 レコード削除 DELETE ボディ

```json
{
  "connection_id": "conn-001",
  "catalog": "Salesforce1",
  "schema": "dbo",
  "table": "Account",
  "where": {
    "Id": "001xxxxxxxxxxxxxxx"
  }
}
```

---

## 5. 技術的制約

### 5.1 主キーの扱い

Connect AI の `/columns` API はカラムのメタデータを返すが、主キー情報（KEY_SEQ 等）が含まれるかはデータソースに依存する。
このため、本実装では以下のアプローチを採用する：

**クライアント主導の WHERE 条件（Frontend からの明示的な渡し）**

- フロントエンドはレコード一覧を取得する際に、全カラムの値をメモリに保持する
- 編集・削除時は、ユーザーが「主キーとして使うカラム」を選択する、もしくは最初のカラムをデフォルトで主キーとして扱う
- `where` オブジェクトとしてフロントエンドからバックエンドに渡す

### 5.2 SQL 実行方式

INSERT / UPDATE / DELETE はすべて `ConnectAIClient.query_data()` の SQL API 経由で実行する。
パラメータ化クエリを必ず使用し、SQL インジェクションを防止する。

```sql
-- INSERT例
INSERT INTO [Salesforce1].[dbo].[Account] ([Name], [Industry]) VALUES (@p0, @p1)

-- UPDATE例
UPDATE [Salesforce1].[dbo].[Account] SET [Name] = @p0, [Industry] = @p1 WHERE [Id] = @pk_Id

-- DELETE例
DELETE FROM [Salesforce1].[dbo].[Account] WHERE [Id] = @pk_Id
```

### 5.3 総件数の取得

`SELECT COUNT(*) FROM [catalog].[schema].[table]` を実行して総件数を取得する。

---

## 6. 非機能要件

- **セキュリティ**: すべての SQL はパラメータ化クエリを使用する
- **エラー表示**: Connect AI エラーは UI 上にわかりやすいメッセージとして表示する
- **ページネーション**: LIMIT / OFFSET で実装する（クライアントサイドではない）

---

## 7. スコープ外（今回実装しない）

- ORDER BY（ソート機能）: 実装コスト高のため、次フェーズ以降
- 件数表示のための COUNT クエリが Connect AI で非サポートの場合のフォールバック
- テーブルごとの主キー自動検出（`/columns` の KEY_SEQ 依存）
- バルク操作（複数件の一括削除など）

---

## 8. フロントエンド画面

### 新規ページ

| ファイル                         | URL             | 説明 |
|---------------------------------|----------------|------|
| `frontend/pages/data-browser.html` | `/data-browser` | データブラウザ（CRUD 操作画面） |

### 画面要素

1. **コネクション選択セクション** — コネクション → カタログ → スキーマ → テーブルのカスケード選択
2. **レコード一覧テーブル** — ヘッダー（カラム名）＋ データ行＋ 各行に編集・削除ボタン
3. **ページネーション** — 「前へ」「次へ」ボタン＋「X 件目 / 全 Y 件」表示
4. **「新規レコード追加」ボタン** — クリックで追加フォームをモーダルまたはインラインで表示
5. **作成フォーム** — カラムメタデータから動的生成
6. **編集フォーム** — 既存値プリフィル付き
7. **削除確認ダイアログ** — 「本当に削除しますか？」
8. **ローディング表示** — 各操作中のスピナー
9. **エラー・成功メッセージ** — 操作結果のフィードバック

---

## 9. 既存コードとの接続点

| 既存ファイル | 変更内容 |
|------------|---------|
| `backend/connectai/client.py` | `insert_data()`, `update_data()`, `delete_data()` メソッドを追加 |
| `backend/api/v1/__init__.py` | `from . import data` を追加 |
| `frontend/pages/dashboard.html` | データブラウザへのリンクを追加 |
| `frontend/static/js/api-client.js` | CRUD 関連メソッドを追加 |
