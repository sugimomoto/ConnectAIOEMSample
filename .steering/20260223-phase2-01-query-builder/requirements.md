# 要求定義書: Phase 2-01 クエリビルダー

**作業ディレクトリ**: `.steering/20260223-phase2-01-query-builder/`
**作成日**: 2026-02-23

---

## 1. 概要

メタデータエクスプローラー（Phase 1-03）の成果物を活用し、SQL を書かずに SELECT クエリを構築・実行できる **ビジュアルクエリビルダー** を実装する。

---

## 2. ユーザーストーリー

| # | ストーリー |
|---|-----------|
| 1 | ユーザーとして、コネクション・カタログ・スキーマ・テーブルをプルダウンで選択し、どのカラムを取得するか選びたい |
| 2 | ユーザーとして、WHERE 条件（カラム・演算子・値）を GUI で複数追加・削除したい |
| 3 | ユーザーとして、「実行」ボタンを押すと結果をページ内のテーブルで確認したい |
| 4 | ユーザーとして、結果件数や実行時間を確認したい |
| 5 | ユーザーとして、結果を CSV としてダウンロードしたい |

---

## 3. 機能要件

### 3.1 データソース選択

- コネクション → カタログ → スキーマ → テーブル をカスケード型プルダウンで選択する（メタデータエクスプローラーと同じ UX）

### 3.2 カラム選択

- テーブルを選択するとカラム一覧が表示される
- `SELECT *` （全カラム）をデフォルトとし、個別に選択切り替えできる
- 選択済みカラムは視覚的にわかるよう表示する

### 3.3 WHERE 条件

- 「+ 条件を追加」ボタンで行を追加できる
- 各行の構成：`[カラム ▼]` `[演算子 ▼]` `[値 入力欄]` `[削除ボタン]`
- 対応演算子：`=`、`<>`、`<`、`>`、`<=`、`>=`、`LIKE`、`IN`、`BETWEEN`
- 複数条件は `AND` で結合する
- 条件が 0 件の場合は WHERE 句なしで実行する

### 3.4 クエリ実行

- 「実行」ボタンで Connect AI の Query API を呼び出す
- バックエンドで SQL を組み立て、**パラメータバインド** でインジェクション対策を行う
- ローディング表示・エラー表示を行う

### 3.5 結果表示

- 結果をページ内テーブルで表示する
- 1 ページあたり 20 件、ページネーションを実装する
- 件数（全件数）と実行時間をヘッダーに表示する
- 結果が 0 件の場合はその旨を表示する

### 3.6 CSV エクスポート

- 「CSV ダウンロード」ボタンで現在の結果をファイルとして保存できる
- ファイル名：`{table_name}_{YYYYMMDD}.csv`

---

## 4. 非機能要件

- SELECT のみ（DML は対象外）
- 未認証アクセスは 401 を返す
- クエリ実行 API はバックエンドで SQL を組み立てる（フロントからの SQL 文字列直渡しは不可）

---

## 5. 受け入れ条件

- [ ] コネクション〜テーブルをプルダウンで選択できる
- [ ] カラム選択（全選択 / 個別選択）ができる
- [ ] WHERE 条件を追加・削除できる（演算子 9 種対応）
- [ ] 「実行」で結果テーブルが表示される
- [ ] 件数と実行時間が表示される
- [ ] ページネーションが動作する
- [ ] CSV ダウンロードができる
- [ ] 未認証アクセスで 401 が返る
- [ ] `pytest backend/tests/` で全テストが通過する

---

## 6. 対象外（次フェーズ以降）

- レコードの作成・編集・削除（Phase 2-02）
- クエリの保存・再実行（Phase 3）
- 複数コネクションをまたいだ JOIN（Phase 3）
- ORDER BY / GROUP BY の GUI 指定（Phase 3）
