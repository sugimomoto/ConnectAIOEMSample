# 要求仕様: Phase 4 - AI アシスタント機能

**作成日**: 2026-02-23
**対応Issue**: [#11](https://github.com/sugimomoto/ConnectAIOEMSample/issues/11)
**ブランチ**: `feature/phase4-ai-assistant`

---

## 概要

CData Connect AI の MCP（Model Context Protocol）機能を活用した AI アシスタント機能を追加する。
ユーザーが自然言語でデータに問い合わせできるチャットインターフェースを提供し、Connect AI OEM の訴求ポイントとしてパートナーへのデモに活用する。

## 背景・目的

- Phase 1〜3 で構築したデータ統合基盤の上に、AI による自然言語インターフェースを追加する
- SQL を知らないビジネスユーザーでもデータにアクセスできることを示す
- **最終目標**: Connect AI OEM を採用したパートナー企業が、自社製品に AI チャット機能を容易に組み込めることを参照実装として実証する

## 機能要件

### コアフェーズ（最初に実装）

#### FR-AI-001: Claude API Key 管理
- ユーザーごとに Claude API Key を設定画面で入力・保存できる
- API Key は暗号化して DB に保存する
- 未設定時はAIアシスタント機能の利用を制限し、設定を促す

#### FR-AI-002: メニューからの直接アクセス
- メインナビゲーションに「AI アシスタント」メニューを追加
- コネクション選択を前提とせず、単独の画面として独立させる

#### FR-AI-003: チャット画面内のカタログ動的選択
- 画面内のドロップダウンでカタログ（コネクション）を選択・切り替えできる
- カタログ未選択時でもチャットを開始でき、AI が必要なカタログを自律的に探索できる
- ストリーミングレスポンス（SSE）で回答をリアルタイム表示する

#### FR-AI-004: バックエンド経由の MCP プロキシ
- 通信経路: フロントエンド → Flask バックエンド → CData Connect AI MCP サーバー
- バックエンドが MCP クライアントとして動作
- 利用 MCP ツール: `getCatalogs`, `getSchemas`, `getTables`, `getColumns`, `queryData`
- Connect AI の `accountId` によるテナント分離を維持する

### 拡張フェーズ（コア完成後）

#### FR-AI-005: MCP ツール呼び出しの可視化
- AI が実行した MCP ツール呼び出しをアコーディオン UI で表示
- ツール名・引数・レスポンスサマリーを確認可能
- デモ時に「AI が Connect AI 経由でデータにアクセスしている」ことを視覚的に説明できる

#### FR-AI-006: 会話履歴管理
- セッション中の会話コンテキストを保持する
- 「新しい会話」ボタンで会話をリセットできる

## 制約事項

- Claude API Key はユーザーが自分で取得・設定する（アプリ側で共有しない）
- MCP との通信はすべてバックエンドを経由する（フロントエンドから直接 MCP に接続しない）
- Connect AI の `accountId` によるテナント分離は既存の仕組みを踏襲する
- フロントエンドのスタック変更なし（HTML5 + Tailwind CSS + Alpine.js）

## ユーザーストーリー

### ストーリー6: Claude API Key の設定
**As a** アプリのユーザー
**I want to** 自分のClaude API Keyを設定する
**So that** AIアシスタント機能を自分のアカウントで利用できる

**受け入れ基準**:
- 設定画面でClaude API Keyを入力・保存できる
- 保存後、APIキーはマスク表示される
- APIキーが未設定の場合、AIアシスタント画面で設定を促すメッセージを表示する

### ストーリー7: 自然言語でのデータ問い合わせ
**As a** ビジネスユーザー
**I want to** メニューからAIアシスタント画面に直接アクセスし、自然言語でデータに質問する
**So that** SQLを知らなくても任意のコネクションのデータから答えを得られる

**受け入れ基準**:
- メインナビゲーションのメニューから直接AIアシスタント画面に遷移できる
- 画面内のドロップダウンでカタログ（コネクション）を動的に選択・切り替えできる
- 「先月の売上上位10件を教えて」のような自然言語の質問ができる
- AIが自動でスキーマを調べ、適切なSQLを生成・実行し、結果を自然言語で回答する
- AIが呼び出したMCPツール（テーブル探索、クエリ実行など）をアコーディオンUIで確認できる

### ストーリー8: AIによるデータ探索支援
**As a** データアナリスト
**I want to** AIと対話しながらデータを探索する
**So that** 未知のデータソースでも素早く全体像を把握できる

**受け入れ基準**:
- フォローアップ質問で会話コンテキストが保持される
- 「さらに条件を絞って」などの追加指示に対応できる
- 「新しい会話」ボタンで会話をリセットして新しい探索を始められる
