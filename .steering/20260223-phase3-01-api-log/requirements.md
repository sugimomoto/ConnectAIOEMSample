# 要求定義: Phase 3-01 Connect AI API リクエストログ

**作業ディレクトリ**: `.steering/20260223-phase3-01-api-log/`
**作成日**: 2026-02-23
**GitHub Issue**: #1

---

## 1. 背景・目的

Phase 1〜2 で実装したサンプルアプリは、Connect AI の各種 API（Account / Connection / Metadata / SQL）を内部で呼び出している。
しかしパートナーエンジニアはその具体的なリクエスト・レスポンス内容を確認する手段がなく、
自社製品への組み込みイメージを掴みにくい状況にある。

本フェーズでは、**アプリから Connect AI に送信したすべての API リクエスト・レスポンスをログとして保存し、
画面から閲覧できる機能**を追加する。

これにより：
- 各画面操作がどのエンドポイントを呼んでいるかが一目でわかる
- リクエスト・レスポンスの JSON 構造を実例として確認できる
- Connect AI API の仕様理解を加速し、パートナーの自社実装を支援できる

---

## 2. 対象機能と優先度

| ID   | 機能                     | 優先度 | 受け入れ条件 |
|------|------------------------|--------|------------|
| P3-1 | API ログの保存           | P0     | Connect AI への全リクエストがログインユーザーに紐付いて DB に保存される |
| P3-2 | API ログ一覧画面          | P0     | 自分のログ一覧がタイムスタンプ降順で表示される |
| P3-3 | API ログ詳細表示          | P0     | リクエスト/レスポンス JSON が整形表示される |
| P3-4 | ログのクリア             | P1     | 自分のログを全件削除できる |

---

## 3. ユーザーストーリー

### 3.1 API ログの保存（P3-1）

**As a** パートナーエンジニア
**I want to** サンプルアプリが Connect AI に送ったすべての API リクエストを記録してほしい
**So that** 自社実装時の参考として、実際のリクエスト/レスポンスの構造を確認できる

**受け入れ基準**:
- アプリ内の全 Connect AI API 呼び出し（GET / POST / DELETE）がログとして保存される
- 保存項目：タイムスタンプ、**ユーザー ID**、HTTP メソッド、エンドポイント（パスのみ）、リクエストボディ（JSON）、レスポンスボディ（JSON）、HTTP ステータスコード、処理時間（ms）
- エラーレスポンスもログとして保存される
- ログは呼び出し時のログインユーザー（`current_user.id`）に紐付けて保存される

### 3.2 API ログ一覧（P3-2）

**As a** パートナーエンジニア
**I want to** 記録された API ログを一覧で確認したい
**So that** どの操作がどの API を呼び出したかをすばやく把握できる

**受け入れ基準**:
- `/api-log` にアクセスすると、**自分が発生させたログのみ**が表示される
- 他ユーザーのログは表示されない
- タイムスタンプ降順（新しい順）で表示される
- 1 件あたりの表示項目：タイムスタンプ・HTTP メソッド・エンドポイント・ステータスコード・処理時間（ms）
- ページネーション（50件/ページ）が動作する
- 未認証のまま `/api-log` にアクセスすると `/login` にリダイレクトされる

### 3.3 API ログ詳細（P3-3）

**As a** パートナーエンジニア
**I want to** 個別のログのリクエスト/レスポンス内容を詳しく確認したい
**So that** JSON の構造・フィールド名・データ型を正確に把握できる

**受け入れ基準**:
- ログ一覧の各行をクリックするとモーダルまたは展開表示でリクエスト/レスポンス JSON が表示される
- JSON はインデント付きで整形（pretty-print）される
- リクエスト・レスポンスのエンドポイント（フルパス）も確認できる

### 3.4 ログのクリア（P3-4）

**As a** パートナーエンジニア
**I want to** ログを全件削除してリセットしたい
**So that** デモ前に余分なログを消してクリーンな状態にできる

**受け入れ基準**:
- 「ログをクリア」ボタンを押すと確認ダイアログが表示される
- 確認後に**自分のログのみ**全件削除され、一覧が空になる
- 他ユーザーのログは削除されない

---

## 4. 機能要件

### 4.1 API エンドポイント

| メソッド | エンドポイント               | 説明                   | 優先度 |
|---------|-----------------------------|----------------------|--------|
| GET     | `/api-log`                  | ログ一覧画面（HTML）    | P0     |
| GET     | `/api/v1/api-logs`          | ログ一覧取得（JSON）    | P0     |
| DELETE  | `/api/v1/api-logs`          | ログ全件削除           | P1     |

### 4.2 ログ一覧 GET レスポンス

```json
{
  "logs": [
    {
      "id": 1,
      "timestamp": "2026-02-23T10:00:00",
      "method": "POST",
      "endpoint": "/query",
      "status_code": 200,
      "elapsed_ms": 342,
      "request_body": "{...}",
      "response_body": "{...}"
    }
  ],
  "total": 100,
  "limit": 50,
  "offset": 0
}
```

### 4.3 ログ一覧 GET クエリパラメータ

| パラメータ | 必須 | デフォルト | 説明 |
|----------|------|-----------|------|
| limit    |      | 50        | 取得件数 |
| offset   |      | 0         | 取得開始位置 |

---

## 5. 技術的制約

### 5.1 ログの保存タイミング

`ConnectAIClient` の `_post()` / `_get()` / `_delete()` メソッド内でリクエスト完了後にログを記録する。

### 5.2 非同期保存（threading.Thread）

ログの書き込みは **Python 標準ライブラリの `threading.Thread`** を使ってバックグラウンドスレッドで実行する。

- メイン処理（Connect AI API のレスポンス返却）をブロックしない
- ログ書き込みの失敗はアプリの動作に影響しない（後述の非機能要件と整合）
- 追加の外部依存ライブラリが不要
- Flask のアプリケーションコンテキストはスレッドに引き継がれないため、
  `app.app_context()` を明示的に push してから DB セッションを操作する

```python
# 実装イメージ
import threading
from flask import current_app

def _save_log_async(app, log_data: dict):
    def _save():
        with app.app_context():
            try:
                log = ApiLog(**log_data)
                db.session.add(log)
                db.session.commit()
            except Exception:
                pass  # ログ失敗はサイレントに無視
    threading.Thread(target=_save, daemon=True).start()
```

### 5.3 ログの保持ポリシー

デモ用途のため件数制限は設けず、手動クリアのみとする。

### 5.4 センシティブ情報の扱い

`Authorization` ヘッダー（JWT）はログに保存しない（リクエストボディのみ記録）。

---

## 6. 非機能要件

- **ログ保存の失敗はアプリの動作に影響させない**（ログ書き込みエラーは無視して処理を続行する）
- **セキュリティ**: ログ閲覧はログイン済みユーザーのみ

---

## 7. スコープ外（今回実装しない）

- ログのフィルタリング・検索
- ログのエクスポート（JSON / CSV）
- ログの自動削除・件数上限

---

## 8. フロントエンド画面

### 新規ページ

| ファイル                           | URL        | 説明 |
|----------------------------------|-----------|------|
| `frontend/pages/api-log.html`    | `/api-log` | API ログ一覧・詳細画面 |

### 画面要素

1. **ログ一覧テーブル** — タイムスタンプ・メソッド・エンドポイント・ステータス・処理時間
2. **詳細モーダル** — クリックでリクエスト/レスポンス JSON を整形表示
3. **ページネーション** — 前へ / 次へ
4. **「ログをクリア」ボタン** — 確認後に全件削除
5. **ローディング・エラー表示**

---

## 9. 既存コードとの接続点

| 既存ファイル                              | 変更内容 |
|----------------------------------------|---------|
| `backend/connectai/client.py`           | `_post()` / `_get()` / `_delete()` にログ記録処理を追加 |
| `backend/models/`                       | `ApiLog` モデルを新規追加（`user_id` FK を含む） |
| `backend/api/v1/__init__.py`            | `from . import api_log` を追加 |
| `frontend/pages/dashboard.html`         | API ログ画面へのリンクを追加 |
| `frontend/static/js/api-client.js`      | `getApiLogs()` / `clearApiLogs()` メソッドを追加 |
